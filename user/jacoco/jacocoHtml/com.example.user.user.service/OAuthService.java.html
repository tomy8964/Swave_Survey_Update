<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OAuthService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">user</a> &gt; <a href="index.source.html" class="el_package">com.example.user.user.service</a> &gt; <span class="el_source">OAuthService.java</span></div><h1>OAuthService.java</h1><pre class="source lang-java linenums">package com.example.user.user.service;

import com.auth0.jwt.JWT;
import com.auth0.jwt.algorithms.Algorithm;
import com.example.user.restAPI.service.OuterRestApiUserService;
import com.example.user.user.domain.User;
import com.example.user.user.domain.UserRole;
import com.example.user.user.exception.UserNotFoundException;
import com.example.user.user.repository.UserRepository;
import com.example.user.util.oAuth.JwtProperties;
import com.example.user.util.oAuth.OauthToken;
import com.example.user.util.oAuth.git.GitProfile;
import com.example.user.util.oAuth.google.GoogleProfile;
import com.example.user.util.oAuth.kakao.KakaoProfile;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

import java.util.*;

<span class="fc" id="L33">@Slf4j</span>
@Service
public class OAuthService {

    private final UserRepository userRepository;
    private final OuterRestApiUserService apiUserService;
<span class="fc" id="L39">    private RestTemplate rt = new RestTemplate();</span>

<span class="fc" id="L41">    public OAuthService(UserRepository userRepository, OuterRestApiUserService apiUserService) {</span>
<span class="fc" id="L42">        this.userRepository = userRepository;</span>
<span class="fc" id="L43">        this.apiUserService = apiUserService;</span>
<span class="fc" id="L44">    }</span>

    public void setRestTemplate(RestTemplate rt) {
<span class="fc" id="L47">        this.rt = rt;</span>
<span class="fc" id="L48">    }</span>

    public OauthToken getAccessToken(String code, String provider) {
<span class="fc" id="L51">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; tokenRequest = getTokenRequest(code, provider);</span>

<span class="fc" id="L53">        ResponseEntity&lt;String&gt; tokenResponse = rt.exchange(</span>
<span class="fc" id="L54">                getProviderTokenUrl(provider),</span>
                HttpMethod.POST,
                tokenRequest,
                String.class
        );

<span class="fc" id="L60">        return getOAuthToken(provider, tokenResponse);</span>
    }

    public Long SaveUser(String token, String provider) {
<span class="fc" id="L64">        User user = null;</span>

<span class="fc" id="L66">        HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L67">        headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + token); //(1-4)</span>
<span class="fc" id="L68">        headers.add(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded;charset=utf-8&quot;);</span>

<span class="pc bpc" id="L70" title="3 of 4 branches missed.">        switch (provider) {</span>
            case &quot;kakao&quot; -&gt; {
<span class="fc" id="L72">                KakaoProfile profile = findKakaoProfile(headers);</span>

<span class="fc" id="L74">                user = userRepository.findByEmailAndProvider(profile.getKakao_account().getEmail(), provider)</span>
<span class="fc" id="L75">                        .orElseGet(() -&gt;</span>
<span class="fc" id="L76">                                User.builder()</span>
<span class="fc" id="L77">                                        .profileImgUrl(profile.getKakao_account().getProfile().getProfile_image_url())</span>
<span class="fc" id="L78">                                        .nickname(profile.getKakao_account().getProfile().getNickname())</span>
<span class="fc" id="L79">                                        .email(profile.getKakao_account().getEmail())</span>
<span class="fc" id="L80">                                        .provider(provider)</span>
<span class="fc" id="L81">                                        .description(&quot;joinByKakao&quot;)</span>
<span class="fc" id="L82">                                        .userRole(UserRole.USER)</span>
<span class="fc" id="L83">                                        .build());</span>
<span class="fc" id="L84">            }</span>
            case &quot;google&quot; -&gt; {
<span class="nc" id="L86">                GoogleProfile profile = findGoogleProfile(headers);</span>

<span class="nc" id="L88">                user = userRepository.findByEmailAndProvider(profile.getEmail(), provider)</span>
<span class="nc" id="L89">                        .orElseGet(() -&gt;</span>
<span class="nc" id="L90">                                User.builder()</span>
<span class="nc" id="L91">                                        .profileImgUrl(profile.getPicture())</span>
<span class="nc" id="L92">                                        .nickname(profile.getName())</span>
<span class="nc" id="L93">                                        .email(profile.getEmail())</span>
<span class="nc" id="L94">                                        .provider(provider)</span>
<span class="nc" id="L95">                                        .description(&quot;joinByGoogle&quot;)</span>
<span class="nc" id="L96">                                        .userRole(UserRole.USER).build());</span>
<span class="nc" id="L97">            }</span>
            case &quot;git&quot; -&gt; {
<span class="nc" id="L99">                GitProfile profile = findGitProfile(headers);</span>
                try {
<span class="nc" id="L101">                    JSONParser parser = new JSONParser();</span>
<span class="nc" id="L102">                    String strJson = profile.getEmail();</span>
<span class="nc" id="L103">                    JSONArray emails = (JSONArray) parser.parse(strJson);</span>
<span class="nc" id="L104">                    JSONObject value = (JSONObject) emails.get(0);</span>

<span class="nc" id="L106">                    String email = (String) value.get(&quot;email&quot;);</span>

<span class="nc" id="L108">                    user = userRepository.findByEmailAndProvider(email, provider)</span>
<span class="nc" id="L109">                            .orElseGet(() -&gt;</span>
<span class="nc" id="L110">                                    User.builder()</span>
<span class="nc" id="L111">                                            .profileImgUrl(profile.getPicture())</span>
<span class="nc" id="L112">                                            .nickname(profile.getName())</span>
<span class="nc" id="L113">                                            .email(email)</span>
<span class="nc" id="L114">                                            .provider(provider)</span>
<span class="nc" id="L115">                                            .userRole(UserRole.USER)</span>
<span class="nc" id="L116">                                            .description(&quot;joinByGit&quot;)</span>
<span class="nc" id="L117">                                            .build());</span>
<span class="nc" id="L118">                } catch (ParseException e) {</span>
<span class="nc" id="L119">                    throw new RuntimeException(&quot;JSON Parsing ERROR&quot;, e);</span>
<span class="nc" id="L120">                }</span>
            }
        }

<span class="fc" id="L124">        User savedUser = userRepository.save(Objects.requireNonNull(user));</span>
        // Document �뿉 �븣由ш린
<span class="fc" id="L126">        apiUserService.sendUserToSurveyDocument(savedUser.getId());</span>
        //湲곗〈 �쉶�썝�씠硫� ���옣 嫄대꼫�쎇怨� �넗�겙 �깮�꽦
<span class="fc" id="L128">        return savedUser.getId();</span>
    }

    public String createJWTToken(Long userId) {
<span class="fc" id="L132">        User user = userRepository.findById(userId).orElseThrow(UserNotFoundException::new);</span>
<span class="fc" id="L133">        return JWT.create()</span>
<span class="fc" id="L134">                .withSubject(user.getEmail())</span>
<span class="fc" id="L135">                .withExpiresAt(new Date(System.currentTimeMillis() + JwtProperties.EXPIRATION_TIME))</span>
<span class="fc" id="L136">                .withClaim(&quot;id&quot;, user.getId())</span>
<span class="fc" id="L137">                .withClaim(&quot;nickname&quot;, user.getNickname())</span>
<span class="fc" id="L138">                .sign(Algorithm.HMAC512(JwtProperties.SECRET));</span>
    }

    private static OauthToken getOAuthToken(String provider, ResponseEntity&lt;String&gt; tokenResponse) {
<span class="fc" id="L142">        ObjectMapper objectMapper = new ObjectMapper();</span>
        OauthToken oauthToken;
        try {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">            if (provider.equals(&quot;git&quot;)) {</span>
                // git�� body媛� 臾몄옄�뿴 �삎�떇
<span class="nc" id="L147">                String responseBody = tokenResponse.getBody();</span>
                // 臾몄옄�뿴 �뙆�떛�븯�뿬 Map 媛앹껜 �깮�꽦
<span class="nc" id="L149">                Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L150">                String[] pairs = Objects.requireNonNull(responseBody).split(&quot;&amp;&quot;);</span>
<span class="nc" id="L151">                Arrays.stream(pairs).map(pair -&gt; pair.split(&quot;=&quot;, 2)).forEach(tokens -&gt; {</span>
<span class="nc" id="L152">                    String key = tokens[0];</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                    String value = tokens.length == 2 ? tokens[1] : &quot;&quot;;</span>
<span class="nc" id="L154">                    map.put(key, value);</span>
<span class="nc" id="L155">                });</span>
                // Map 媛앹껜瑜� JSON �삎�깭濡� 蹂��솚
<span class="nc" id="L157">                ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L158">                String json = mapper.writeValueAsString(map);</span>

<span class="nc" id="L160">                oauthToken = objectMapper.readValue(json, OauthToken.class);</span>
<span class="nc" id="L161">            } else {</span>
<span class="fc" id="L162">                oauthToken = objectMapper.readValue(tokenResponse.getBody(), OauthToken.class);</span>
            }
<span class="nc" id="L164">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L165">            throw new RuntimeException(&quot;Json Parsing Error&quot;, e);</span>
<span class="fc" id="L166">        }</span>
<span class="fc" id="L167">        return oauthToken;</span>
    }

    private static HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; getTokenRequest(String code, String provider) {
        String grantType;
        String clientId;
        String clientSecret;
        String redirectUri;

<span class="pc bpc" id="L176" title="3 of 4 branches missed.">        switch (provider) {</span>
            case &quot;kakao&quot; -&gt; {
<span class="fc" id="L178">                grantType = &quot;authorization_code&quot;;</span>
<span class="fc" id="L179">                clientId = &quot;4646a32b25c060e42407ceb8c13ef14a&quot;;</span>
<span class="fc" id="L180">                clientSecret = &quot;AWyAH1M24R9EYfUjJ1KCxcsh3DwvK8F7&quot;;</span>
<span class="fc" id="L181">                redirectUri = &quot;http://172.16.210.80:80/oauth/callback/kakao&quot;;</span>
<span class="fc" id="L182">            }</span>
            case &quot;google&quot; -&gt; {
<span class="nc" id="L184">                grantType = &quot;authorization_code&quot;;</span>
<span class="nc" id="L185">                clientId = &quot;278703087355-limdvm0almc07ldn934on122iorpfdv5.apps.googleusercontent.com&quot;;</span>
<span class="nc" id="L186">                clientSecret = &quot;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&quot;;</span>
<span class="nc" id="L187">                redirectUri = &quot;http://172.16.210.80:80/oauth/callback/google&quot;;</span>
<span class="nc" id="L188">            }</span>
            case &quot;git&quot; -&gt; {
<span class="nc" id="L190">                grantType = &quot;authorization_code&quot;;</span>
<span class="nc" id="L191">                clientId = &quot;Iv1.986aaa4d78140fb7&quot;;</span>
<span class="nc" id="L192">                clientSecret = &quot;0c8e730012e8ca8e41a3922358572457f5cc57e4&quot;;</span>
<span class="nc" id="L193">                redirectUri = &quot;http://172.16.210.80:80/oauth/callback/git&quot;;</span>
<span class="nc" id="L194">            }</span>
<span class="nc" id="L195">            default -&gt; throw new IllegalArgumentException(&quot;Invalid Provider: &quot; + provider);</span>
        }

<span class="fc" id="L198">        HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L199">        headers.add(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded;charset=utf-8&quot;);</span>

<span class="fc" id="L201">        MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;();</span>
<span class="fc" id="L202">        params.add(&quot;grant_type&quot;, grantType);</span>
<span class="fc" id="L203">        params.add(&quot;client_id&quot;, clientId);</span>
<span class="fc" id="L204">        params.add(&quot;redirect_uri&quot;, redirectUri);</span>
<span class="fc" id="L205">        params.add(&quot;code&quot;, code);</span>
<span class="fc" id="L206">        params.add(&quot;client_secret&quot;, clientSecret);</span>
<span class="fc" id="L207">        return new HttpEntity&lt;&gt;(params, headers);</span>
    }

    //provider�뿉 �뵲�씪 URL �젣怨� 援щ텇
    private String getProviderTokenUrl(String provider) {
<span class="pc bpc" id="L212" title="3 of 4 branches missed.">        return switch (provider) {</span>
<span class="fc" id="L213">            case &quot;kakao&quot; -&gt; &quot;https://kauth.kakao.com/oauth/token&quot;;</span>
<span class="nc" id="L214">            case &quot;google&quot; -&gt; &quot;https://oauth2.googleapis.com/token&quot;;</span>
<span class="nc" id="L215">            case &quot;git&quot; -&gt; &quot;https://github.com/login/oauth/access_token&quot;;</span>
<span class="nc" id="L216">            default -&gt; throw new IllegalArgumentException(&quot;Invalid Provider: &quot; + provider);</span>
        };
    }

    private KakaoProfile findKakaoProfile(HttpHeaders headers) {

<span class="fc" id="L222">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; kakaoProfileRequest =</span>
                new HttpEntity&lt;&gt;(headers);

        // Http �슂泥� (POST 諛⑹떇) �썑, response 蹂��닔�뿉 �쓳�떟�쓣 諛쏆쓬
<span class="fc" id="L226">        ResponseEntity&lt;String&gt; kakaoProfileResponse = rt.exchange(</span>
                &quot;https://kapi.kakao.com/v2/user/me&quot;,
                HttpMethod.POST,
                kakaoProfileRequest,
                String.class
        );

<span class="fc" id="L233">        ObjectMapper objectMapper = new ObjectMapper();</span>
        KakaoProfile kakaoProfile;

        try {
<span class="fc" id="L237">            kakaoProfile = objectMapper.readValue(kakaoProfileResponse.getBody(), KakaoProfile.class);</span>
<span class="nc" id="L238">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L239">            throw new RuntimeException(e);</span>
<span class="fc" id="L240">        }</span>

<span class="fc" id="L242">        return kakaoProfile;</span>
    }

    private GoogleProfile findGoogleProfile(HttpHeaders headers) {

<span class="nc" id="L247">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; googleProfileRequest =</span>
                new HttpEntity&lt;&gt;(headers);

        // Http �슂泥� (POST 諛⑹떇) �썑, response 蹂��닔�뿉 �쓳�떟�쓣 諛쏆쓬
<span class="nc" id="L251">        ResponseEntity&lt;String&gt; googleProfileResponse = rt.exchange(</span>
                &quot;https://www.googleapis.com/oauth2/v3/userinfo&quot;,
                HttpMethod.POST,
                googleProfileRequest,
                String.class
        );

<span class="nc" id="L258">        ObjectMapper objectMapper = new ObjectMapper();</span>
        GoogleProfile googleProfile;
        try {
<span class="nc" id="L261">            googleProfile = objectMapper.readValue(googleProfileResponse.getBody(), GoogleProfile.class);</span>
<span class="nc" id="L262">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L263">            throw new RuntimeException(e);</span>
<span class="nc" id="L264">        }</span>

<span class="nc" id="L266">        return googleProfile;</span>
    }

    private GitProfile findGitProfile(HttpHeaders headers) {

<span class="nc" id="L271">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; gitProfileRequest =</span>
                new HttpEntity&lt;&gt;(headers);
        //spring oauth access token gitHub server userinfo
        // Http �슂泥� (POST 諛⑹떇) �썑, response 蹂��닔�뿉 �쓳�떟�쓣 諛쏆쓬
<span class="nc" id="L275">        ResponseEntity&lt;String&gt; gitProfileResponse = rt.exchange(</span>
                &quot;https://api.github.com/user&quot;,
                HttpMethod.GET,
                gitProfileRequest,
                String.class
        );
        String name;
        String picture;
        try {
<span class="nc" id="L284">            JSONParser parser = new JSONParser();</span>
<span class="nc" id="L285">            String userInfo = gitProfileResponse.getBody();</span>
<span class="nc" id="L286">            JSONObject jsonObject = (JSONObject) parser.parse(userInfo);</span>
<span class="nc" id="L287">            name = (String) jsonObject.get(&quot;login&quot;);</span>
<span class="nc" id="L288">            picture = (String) jsonObject.get(&quot;avatar_url&quot;);</span>
<span class="nc" id="L289">        } catch (ParseException e) {</span>
<span class="nc" id="L290">            throw new RuntimeException(e);</span>
<span class="nc" id="L291">        }</span>


        //Git�� email �젙蹂대�� �떎�떆 �븳踰� 諛쏆븘���빞 �븿
<span class="nc" id="L295">        ResponseEntity&lt;String&gt; gitEmailResponse = rt.exchange(</span>
                &quot;https://api.github.com/user/emails&quot;,
                HttpMethod.GET,
                gitProfileRequest,
                String.class
        );

<span class="nc" id="L302">        ObjectMapper objectMapper = new ObjectMapper();</span>
        GitProfile gitProfile;
        try {
<span class="nc" id="L305">            gitProfile = objectMapper.readValue(gitProfileResponse.getBody(), GitProfile.class);</span>

<span class="nc" id="L307">            gitProfile.email = gitEmailResponse.getBody();</span>
<span class="nc" id="L308">            gitProfile.name = name;</span>
<span class="nc" id="L309">            gitProfile.picture = picture;</span>

<span class="nc" id="L311">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L312">            throw new RuntimeException(e);</span>
<span class="nc" id="L313">        }</span>

<span class="nc" id="L315">        return gitProfile;</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>